<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Testes de SincronizaÃ§Ã£o - Minhas Contas</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #1a1a2e;
            color: white;
        }
        .test-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
        }
        .test-button {
            background: #e94560;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #ff6b6b;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .status.success { background: #2ed573; }
        .status.error { background: #ff6b6b; }
        .status.warning { background: #ffa502; }
        .log {
            background: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª Testes de SincronizaÃ§Ã£o AutomÃ¡tica</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š Status da AplicaÃ§Ã£o</h2>
        <div id="status-app"></div>
        <button class="test-button" onclick="atualizarStatus()">ğŸ”„ Atualizar Status</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”— Teste de Conectividade</h2>
        <button class="test-button" onclick="testarBackend()">ğŸŒ Testar Backend</button>
        <button class="test-button" onclick="testarLocalStorage()">ğŸ’¾ Testar localStorage</button>
        <div id="resultado-conectividade"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ Teste de SincronizaÃ§Ã£o</h2>
        <button class="test-button" onclick="testarSincronizacao()">ğŸ”„ Testar SincronizaÃ§Ã£o</button>
        <button class="test-button" onclick="simularDadosPendentes()">ğŸ“ Simular Dados Pendentes</button>
        <button class="test-button" onclick="limparDadosTeste()">ğŸ§¹ Limpar Dados de Teste</button>
        <div id="resultado-sincronizacao"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“± Teste de CenÃ¡rios</h2>
        <button class="test-button" onclick="testarCenarioOffline()">ğŸ“´ Simular Backend Offline</button>
        <button class="test-button" onclick="testarCenarioOnline()">ğŸŒ Simular Backend Online</button>
        <button class="test-button" onclick="testarLimpezaAutomatica()">ğŸ§¹ Testar Limpeza AutomÃ¡tica</div>
        <div id="resultado-cenarios"></div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ Logs de Teste</h2>
        <button class="test-button" onclick="limparLogs()">ğŸ—‘ï¸ Limpar Logs</button>
        <div id="logs" class="log"></div>
    </div>

    <script src="../config.js"></script>
    <script src="javascript/main.js"></script>
    <script>
        // FunÃ§Ã£o para adicionar logs
        function adicionarLog(mensagem, tipo = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${mensagem}`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }

        // FunÃ§Ã£o para limpar logs
        function limparLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // FunÃ§Ã£o para mostrar resultado
        function mostrarResultado(elementId, mensagem, tipo = 'success') {
            const elemento = document.getElementById(elementId);
            elemento.innerHTML = `<div class="status ${tipo}">${mensagem}</div>`;
        }

        // Atualizar status da aplicaÃ§Ã£o
        async function atualizarStatus() {
            try {
                const status = window.app.obterStatusSincronizacao();
                const backendOnline = await window.app.verificarStatusBackend();
                
                const statusHtml = `
                    <div class="status ${backendOnline ? 'success' : 'error'}">
                        <strong>Backend:</strong> ${backendOnline ? 'Online' : 'Offline'}
                    </div>
                    <div class="status ${status.dadosPendentes ? 'warning' : 'success'}">
                        <strong>Dados Pendentes:</strong> ${status.dadosPendentes ? 'Sim' : 'NÃ£o'}
                    </div>
                    <div class="status ${status.sincronizacaoAtiva ? 'warning' : 'success'}">
                        <strong>SincronizaÃ§Ã£o Ativa:</strong> ${status.sincronizacaoAtiva ? 'Sim' : 'NÃ£o'}
                    </div>
                    <div class="status success">
                        <strong>Ãšltima SincronizaÃ§Ã£o:</strong> ${status.ultimaSincronizacao || 'Nunca'}
                    </div>
                `;
                
                document.getElementById('status-app').innerHTML = statusHtml;
                adicionarLog('Status atualizado');
            } catch (error) {
                adicionarLog(`Erro ao atualizar status: ${error.message}`, 'error');
            }
        }

        // Testar conectividade com backend
        async function testarBackend() {
            try {
                adicionarLog('Testando conectividade com backend...');
                const online = await window.app.verificarStatusBackend();
                
                if (online) {
                    mostrarResultado('resultado-conectividade', 'âœ… Backend online e respondendo', 'success');
                    adicionarLog('Backend online');
                } else {
                    mostrarResultado('resultado-conectividade', 'âŒ Backend offline ou nÃ£o respondendo', 'error');
                    adicionarLog('Backend offline');
                }
            } catch (error) {
                mostrarResultado('resultado-conectividade', `âŒ Erro: ${error.message}`, 'error');
                adicionarLog(`Erro no teste de backend: ${error.message}`, 'error');
            }
        }

        // Testar localStorage
        function testarLocalStorage() {
            try {
                adicionarLog('Testando localStorage...');
                
                // Testar escrita
                const testData = { teste: 'dados', timestamp: new Date().toISOString() };
                localStorage.setItem('teste-sincronizacao', JSON.stringify(testData));
                
                // Testar leitura
                const dadosLidos = localStorage.getItem('teste-sincronizacao');
                const dadosParseados = JSON.parse(dadosLidos);
                
                // Limpar dados de teste
                localStorage.removeItem('teste-sincronizacao');
                
                if (dadosParseados.teste === 'dados') {
                    mostrarResultado('resultado-conectividade', 'âœ… localStorage funcionando corretamente', 'success');
                    adicionarLog('localStorage OK');
                } else {
                    throw new Error('Dados nÃ£o correspondem');
                }
            } catch (error) {
                mostrarResultado('resultado-conectividade', `âŒ Erro no localStorage: ${error.message}`, 'error');
                adicionarLog(`Erro no localStorage: ${error.message}`, 'error');
            }
        }

        // Testar sincronizaÃ§Ã£o
        async function testarSincronizacao() {
            try {
                adicionarLog('Testando sincronizaÃ§Ã£o...');
                await window.app.sincronizarDadosPendentes();
                mostrarResultado('resultado-sincronizacao', 'âœ… Teste de sincronizaÃ§Ã£o concluÃ­do', 'success');
                adicionarLog('SincronizaÃ§Ã£o testada');
            } catch (error) {
                mostrarResultado('resultado-sincronizacao', `âŒ Erro na sincronizaÃ§Ã£o: ${error.message}`, 'error');
                adicionarLog(`Erro na sincronizaÃ§Ã£o: ${error.message}`, 'error');
            }
        }

        // Simular dados pendentes
        function simularDadosPendentes() {
            try {
                adicionarLog('Simulando dados pendentes...');
                
                const dadosTeste = {
                    receitas: { '05': 1000, '15': 1500, '20': 800, '30': 1200 },
                    despesas: {
                        '05': [{ id: 1, descricao: 'Teste', valor: 500, dia: '05' }],
                        '15': [],
                        '20': [],
                        '30': []
                    },
                    timestamp: new Date().toISOString(),
                    versao: '2.0',
                    id: Date.now()
                };
                
                localStorage.setItem('minhasContas', JSON.stringify(dadosTeste));
                window.app.dadosPendentes = true;
                
                mostrarResultado('resultado-sincronizacao', 'âœ… Dados de teste criados no localStorage', 'success');
                adicionarLog('Dados pendentes simulados');
            } catch (error) {
                mostrarResultado('resultado-sincronizacao', `âŒ Erro ao simular dados: ${error.message}`, 'error');
                adicionarLog(`Erro ao simular dados: ${error.message}`, 'error');
            }
        }

        // Limpar dados de teste
        function limparDadosTeste() {
            try {
                adicionarLog('Limpando dados de teste...');
                localStorage.removeItem('minhasContas');
                window.app.dadosPendentes = false;
                mostrarResultado('resultado-sincronizacao', 'âœ… Dados de teste removidos', 'success');
                adicionarLog('Dados de teste limpos');
            } catch (error) {
                mostrarResultado('resultado-sincronizacao', `âŒ Erro ao limpar dados: ${error.message}`, 'error');
                adicionarLog(`Erro ao limpar dados: ${error.message}`, 'error');
            }
        }

        // Testar cenÃ¡rio offline
        async function testarCenarioOffline() {
            try {
                adicionarLog('Testando cenÃ¡rio offline...');
                
                // Simular dados pendentes
                simularDadosPendentes();
                
                // Verificar se dados ficam no localStorage
                const dadosSalvos = localStorage.getItem('minhasContas');
                if (dadosSalvos) {
                    mostrarResultado('resultado-cenarios', 'âœ… CenÃ¡rio offline: dados salvos no localStorage', 'success');
                    adicionarLog('CenÃ¡rio offline testado com sucesso');
                } else {
                    throw new Error('Dados nÃ£o foram salvos no localStorage');
                }
            } catch (error) {
                mostrarResultado('resultado-cenarios', `âŒ Erro no cenÃ¡rio offline: ${error.message}`, 'error');
                adicionarLog(`Erro no cenÃ¡rio offline: ${error.message}`, 'error');
            }
        }

        // Testar cenÃ¡rio online
        async function testarCenarioOnline() {
            try {
                adicionarLog('Testando cenÃ¡rio online...');
                
                // Verificar se backend estÃ¡ online
                const backendOnline = await window.app.verificarStatusBackend();
                if (!backendOnline) {
                    mostrarResultado('resultado-cenarios', 'âš ï¸ Backend offline - nÃ£o Ã© possÃ­vel testar cenÃ¡rio online', 'warning');
                    adicionarLog('Backend offline, cenÃ¡rio online nÃ£o testado');
                    return;
                }
                
                // Simular dados e tentar sincronizar
                simularDadosPendentes();
                await window.app.sincronizarDadosPendentes();
                
                // Verificar se dados foram limpos do localStorage
                const dadosAposSincronizacao = localStorage.getItem('minhasContas');
                if (!dadosAposSincronizacao) {
                    mostrarResultado('resultado-cenarios', 'âœ… CenÃ¡rio online: dados sincronizados e localStorage limpo', 'success');
                    adicionarLog('CenÃ¡rio online testado com sucesso');
                } else {
                    throw new Error('Dados nÃ£o foram limpos do localStorage apÃ³s sincronizaÃ§Ã£o');
                }
            } catch (error) {
                mostrarResultado('resultado-cenarios', `âŒ Erro no cenÃ¡rio online: ${error.message}`, 'error');
                adicionarLog(`Erro no cenÃ¡rio online: ${error.message}`, 'error');
            }
        }

        // Testar limpeza automÃ¡tica
        async function testarLimpezaAutomatica() {
            try {
                adicionarLog('Testando limpeza automÃ¡tica...');
                
                // Simular dados
                simularDadosPendentes();
                
                // Verificar se dados existem
                const dadosAntes = localStorage.getItem('minhasContas');
                if (!dadosAntes) {
                    throw new Error('Dados nÃ£o foram criados para teste');
                }
                
                // Executar limpeza
                window.app.limparLocalStorage();
                
                // Verificar se dados foram removidos
                const dadosDepois = localStorage.getItem('minhasContas');
                if (!dadosDepois) {
                    mostrarResultado('resultado-cenarios', 'âœ… Limpeza automÃ¡tica funcionando corretamente', 'success');
                    adicionarLog('Limpeza automÃ¡tica testada com sucesso');
                } else {
                    throw new Error('Dados nÃ£o foram removidos do localStorage');
                }
            } catch (error) {
                mostrarResultado('resultado-cenarios', `âŒ Erro na limpeza automÃ¡tica: ${error.message}`, 'error');
                adicionarLog(`Erro na limpeza automÃ¡tica: ${error.message}`, 'error');
            }
        }

        // Inicializar pÃ¡gina de testes
        document.addEventListener('DOMContentLoaded', () => {
            adicionarLog('PÃ¡gina de testes carregada');
            setTimeout(atualizarStatus, 1000);
        });
    </script>
</body>
</html> 